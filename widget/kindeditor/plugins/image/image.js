KindEditor.plugin("image",function(e){var a=this,t="image",i=e.undef(a.allowImageUpload,!0),l=e.undef(a.formatUploadUrl,!0),n=e.undef(a.allowFileManager,!1),o=e.undef(a.uploadJson,a.basePath+"php/upload_json.php"),d=e.undef(a.imageTabIndex,0),r=a.pluginsPath+"image/images/",s=e.undef(a.extraFileUploadParams,{}),u=e.undef(a.filePostName,"imgFile"),g=e.undef(a.fillDescAfterUploadImage,!1),c=a.lang(t+".");a.plugin.imageDialog=function(i){function d(e,a){L.val(e),P.val(a),H=e,j=a}var m=(i.imageUrl,e.undef(i.imageWidth,""),e.undef(i.imageHeight,""),e.undef(i.imageTitle,""),e.undef(i.imageAlign,""),e.undef(i.showRemote,!0)),h=e.undef(i.showLocal,!0),p=e.undef(i.tabIndex,0),f=i.clickFn,v="kindeditor_upload_iframe_"+(new Date).getTime(),b=[];for(var k in s)b.push('<input type="hidden" name="'+k+'" value="'+s[k]+'" />');var w,y=['<div style="padding:20px;">','<div class="tabs"></div>','<div class="tab1" style="display:none;">','<div class="ke-dialog-row">','<label for="remoteUrl" style="width:60px;">'+c.remoteUrl+"</label>",'<input type="text" id="remoteUrl" class="ke-input-text" name="url" value="" style="width:200px;" /> &nbsp;','<span class="ke-button-common ke-button-outer">','<input type="button" class="ke-button-common ke-button" name="viewServer" value="'+c.viewServer+'" />',"</span>","</div>",'<div class="ke-dialog-row">','<label for="remoteWidth" style="width:60px;">'+c.size+"</label>",c.width+' <input type="text" id="remoteWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> ',c.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> ','<img class="ke-refresh-btn" src="'+r+'refresh.png" width="16" height="16" alt="" style="cursor:pointer;" title="'+c.resetSize+'" />',"</div>",'<div class="ke-dialog-row">','<label style="width:60px;">'+c.align+"</label>",'<input type="radio" name="align" class="ke-inline-block" value="" checked="checked" /> <img name="defaultImg" src="'+r+'align_top.gif" width="23" height="25" alt="" />',' <input type="radio" name="align" class="ke-inline-block" value="left" /> <img name="leftImg" src="'+r+'align_left.gif" width="23" height="25" alt="" />',' <input type="radio" name="align" class="ke-inline-block" value="right" /> <img name="rightImg" src="'+r+'align_right.gif" width="23" height="25" alt="" />',"</div>",'<div class="ke-dialog-row">','<label for="remoteTitle" style="width:60px;">'+c.imgTitle+"</label>",'<input type="text" id="remoteTitle" class="ke-input-text" name="title" value="" style="width:200px;" />',"</div>","</div>",'<div class="tab2" style="display:none;">','<iframe name="'+v+'" style="display:none;"></iframe>','<form class="ke-upload-area ke-form" method="post" enctype="multipart/form-data" target="'+v+'" action="'+e.addParam(o,"dir=image")+'">','<div class="ke-dialog-row">',b.join(""),'<label style="width:60px;">'+c.localUrl+"</label>",'<input type="text" name="localUrl" class="ke-input-text" tabindex="-1" style="width:200px;" readonly="true" /> &nbsp;','<input type="button" class="ke-upload-button" value="'+c.upload+'" />',"</div>","</form>","</div>","</div>"].join(""),x=h||n?450:400,U=h&&m?300:250,I=a.createDialog({name:t,width:x,height:U,title:a.lang(t),body:y,yesBtn:{name:a.lang("yes"),click:function(){if(!I.isLoading){if(h&&m&&w&&1===w.selectedIndex||!m)return""==B.fileBox.val()?void alert(a.lang("pleaseSelectFile")):(I.showLoading(a.lang("uploadLoading")),B.submit(),void D.val(""));var t=e.trim(S.val()),i=L.val(),l=P.val(),n=_.val(),o="";return A.each(function(){return this.checked?(o=this.value,!1):void 0}),"http://"==t||e.invalidUrl(t)?(alert(a.lang("invalidUrl")),void S[0].focus()):/^\d*$/.test(i)?/^\d*$/.test(l)?void f.call(a,t,n,i,l,0,o):(alert(a.lang("invalidHeight")),void P[0].focus()):(alert(a.lang("invalidWidth")),void L[0].focus())}}},beforeRemove:function(){F.unbind(),L.unbind(),P.unbind(),W.unbind()}}),T=I.div,S=e('[name="url"]',T),D=e('[name="localUrl"]',T),F=e('[name="viewServer"]',T),L=e('.tab1 [name="width"]',T),P=e('.tab1 [name="height"]',T),W=e(".ke-refresh-btn",T),_=e('.tab1 [name="title"]',T),A=e('.tab1 [name="align"]',T);m&&h?(w=e.tabs({src:e(".tabs",T),afterSelect:function(){}}),w.add({title:c.remoteImage,panel:e(".tab1",T)}),w.add({title:c.localImage,panel:e(".tab2",T)}),w.select(p)):m?e(".tab1",T).show():h&&e(".tab2",T).show();var B=e.uploadbutton({button:e(".ke-upload-button",T)[0],fieldName:u,url:e.addParam(o,"dir=image"),form:e(".ke-form",T),target:v,width:60,afterUpload:function(i){if(I.hideLoading(),0===i.error){var n=i.url;l&&(n=e.formatUrl(n,"absolute")),a.afterUpload&&a.afterUpload.call(a,n,i,t),g?(e(".ke-dialog-row #remoteUrl",T).val(n),e(".ke-tabs-li",T)[0].click(),e(".ke-refresh-btn",T).click()):f.call(a,n,i.title,i.width,i.height,i.border,i.align)}else alert(i.message)},afterError:function(e){I.hideLoading(),a.errorDialog(e)}});B.fileBox.change(function(){D.val(B.fileBox.val())}),n?F.click(function(){a.loadPlugin("filemanager",function(){a.plugin.filemanagerDialog({viewType:"VIEW",dirName:"image",clickFn:function(t){a.dialogs.length>1&&(e('[name="url"]',T).val(t),a.afterSelectFile&&a.afterSelectFile.call(a,t),a.hideDialog())}})})}):F.hide();var H=0,j=0;return W.click(function(){var a=e('<img src="'+S.val()+'" />',document).css({position:"absolute",visibility:"hidden",top:0,left:"-1000px"});a.bind("load",function(){d(a.width(),a.height()),a.remove()}),e(document.body).append(a)}),L.change(function(){H>0&&P.val(Math.round(j/H*parseInt(this.value,10)))}),P.change(function(){j>0&&L.val(Math.round(H/j*parseInt(this.value,10)))}),S.val(i.imageUrl),d(i.imageWidth,i.imageHeight),_.val(i.imageTitle),A.each(function(){return this.value===i.imageAlign?(this.checked=!0,!1):void 0}),0===p&&(S[0].focus(),S[0].select()),I},a.plugin.image={edit:function(){var e=a.plugin.getSelectedImage();a.plugin.imageDialog({imageUrl:e?e.attr("data-ke-src"):"http://",imageWidth:e?e.width():"",imageHeight:e?e.height():"",imageTitle:e?e.attr("title"):"",imageAlign:e?e.attr("align"):"",showRemote:!0,showLocal:i,tabIndex:e?0:d,clickFn:function(e,t,i,l,n,o){a.exec("insertimage",e,t,i,l,n,o),setTimeout(function(){a.hideDialog().focus()},0)}})},"delete":function(){var e=a.plugin.getSelectedImage();"a"==e.parent().name&&(e=e.parent()),e.remove()}},a.clickToolbar(t,a.plugin.image.edit)});