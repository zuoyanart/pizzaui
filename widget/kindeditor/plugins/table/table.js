KindEditor.plugin("table",function(e){function l(e,l){l=l.toUpperCase(),e.css("background-color",l),e.css("color","#000000"===l?"#FFFFFF":"#000000"),e.html(l)}function t(t,o){function a(){e.each(d,function(){this.remove()}),d=[],e(document).unbind("click,mousedown",a),t.unbind("click,mousedown",a)}o.bind("click,mousedown",function(e){e.stopPropagation()}),o.click(function(){a();var o=e(this),i=o.pos(),r=e.colorpicker({x:i.x,y:i.y+o.height(),z:811214,selectedColor:e(this).html(),colors:n.colorTable,noColor:n.lang("noColor"),shadowMode:n.shadowMode,click:function(e){l(o,e),a()}});d.push(r),e(document).bind("click,mousedown",a),t.bind("click,mousedown",a)})}function o(e,l,t){for(var o=0,n=0,a=l.cells.length;a>n&&l.cells[n]!=t;n++)o+=l.cells[n].rowSpan-1;return t.cellIndex-o}var n=this,a="table",i=n.lang(a+"."),r="ke-zeroborder",d=[];n.plugin.table={prop:function(o){var d=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keRows" style="width:90px;">'+i.cells+"</label>",i.rows+' <input type="text" id="keRows" class="ke-input-text ke-input-number" name="rows" value="" maxlength="4" /> &nbsp; ',i.cols+' <input type="text" class="ke-input-text ke-input-number" name="cols" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+i.size+"</label>",i.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+i.percent+"</option>",'<option value="px">'+i.px+"</option>","</select> &nbsp; ",i.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+i.percent+"</option>",'<option value="px">'+i.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="kePadding" style="width:90px;">'+i.space+"</label>",i.padding+' <input type="text" id="kePadding" class="ke-input-text ke-input-number" name="padding" value="" maxlength="4" /> &nbsp; ',i.spacing+' <input type="text" class="ke-input-text ke-input-number" name="spacing" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+i.align+"</label>",'<select id="keAlign" name="align">','<option value="">'+i.alignDefault+"</option>",'<option value="left">'+i.alignLeft+"</option>",'<option value="center">'+i.alignCenter+"</option>",'<option value="right">'+i.alignRight+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+i.border+"</label>",i.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',i.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+i.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join(""),c=n.createDialog({name:a,width:500,title:n.lang(a),body:d,beforeRemove:function(){x.unbind()},yesBtn:{name:n.lang("yes"),click:function(){var l=p.val(),t=g.val(),o=v.val(),a=u.val(),i=h.val(),d=m.val(),c=b.val(),s=w.val(),y=k.val(),C=f.val(),B=e(x[0]).html()||"",T=e(x[1]).html()||"";if(0==l||!/^\d+$/.test(l))return alert(n.lang("invalidRows")),void p[0].focus();if(0==t||!/^\d+$/.test(t))return alert(n.lang("invalidRows")),void g[0].focus();if(!/^\d*$/.test(o))return alert(n.lang("invalidWidth")),void v[0].focus();if(!/^\d*$/.test(a))return alert(n.lang("invalidHeight")),void u[0].focus();if(!/^\d*$/.test(c))return alert(n.lang("invalidPadding")),void b[0].focus();if(!/^\d*$/.test(s))return alert(n.lang("invalidSpacing")),void w[0].focus();if(!/^\d*$/.test(C))return alert(n.lang("invalidBorder")),void f[0].focus();if(S)return""!==o?S.width(o+i):S.css("width",""),void 0!==S[0].width&&S.removeAttr("width"),""!==a?S.height(a+d):S.css("height",""),void 0!==S[0].height&&S.removeAttr("height"),S.css("background-color",T),void 0!==S[0].bgColor&&S.removeAttr("bgColor"),""!==c?S[0].cellPadding=c:S.removeAttr("cellPadding"),""!==s?S[0].cellSpacing=s:S.removeAttr("cellSpacing"),""!==y?S[0].align=y:S.removeAttr("align"),""!==C?S.attr("border",C):S.removeAttr("border"),""===C||"0"===C?S.addClass(r):S.removeClass(r),""!==B?S.attr("borderColor",B):S.removeAttr("borderColor"),void n.hideDialog().focus();var A="";""!==o&&(A+="width:"+o+i+";"),""!==a&&(A+="height:"+a+d+";"),""!==T&&(A+="background-color:"+T+";");var I="<table";""!==A&&(I+=' style="'+A+'"'),""!==c&&(I+=' cellpadding="'+c+'"'),""!==s&&(I+=' cellspacing="'+s+'"'),""!==y&&(I+=' align="'+y+'"'),""!==C&&(I+=' border="'+C+'"'),(""===C||"0"===C)&&(I+=' class="'+r+'"'),""!==B&&(I+=' bordercolor="'+B+'"'),I+=">";for(var R=0;l>R;R++){I+="<tr>";for(var $=0;t>$;$++)I+="<td>"+(e.IE?"&nbsp;":"<br />")+"</td>";I+="</tr>"}I+="</table>",e.IE||(I+="<br />"),n.insertHtml(I),n.select().hideDialog().focus(),n.addBookmark()}}}),s=c.div,p=e('[name="rows"]',s).val(3),g=e('[name="cols"]',s).val(2),v=e('[name="width"]',s).val(100),u=e('[name="height"]',s),h=e('[name="widthType"]',s),m=e('[name="heightType"]',s),b=e('[name="padding"]',s).val(2),w=e('[name="spacing"]',s).val(0),k=e('[name="align"]',s),f=e('[name="border"]',s).val(1),x=e(".ke-input-color",s);t(s,x.eq(0)),t(s,x.eq(1)),l(x.eq(0),"#000000"),l(x.eq(1),""),p[0].focus(),p[0].select();var S;if(!o&&(S=n.plugin.getSelectedTable())){p.val(S[0].rows.length),g.val(S[0].rows.length>0?S[0].rows[0].cells.length:0),p.attr("disabled",!0),g.attr("disabled",!0);var y,C=S[0].style.width||S[0].width,B=S[0].style.height||S[0].height;void 0!==C&&(y=/^(\d+)((?:px|%)*)$/.exec(C))?(v.val(y[1]),h.val(y[2])):v.val(""),void 0!==B&&(y=/^(\d+)((?:px|%)*)$/.exec(B))&&(u.val(y[1]),m.val(y[2])),b.val(S[0].cellPadding||""),w.val(S[0].cellSpacing||""),k.val(S[0].align||""),f.val(void 0===S[0].border?"":S[0].border),l(x.eq(0),e.toHex(S.attr("borderColor")||"")),l(x.eq(1),e.toHex(S[0].style.backgroundColor||S[0].bgColor||"")),v[0].focus(),v[0].select()}},cellprop:function(){var o=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+i.size+"</label>",i.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+i.percent+"</option>",'<option value="px">'+i.px+"</option>","</select> &nbsp; ",i.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+i.percent+"</option>",'<option value="px">'+i.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+i.align+"</label>",i.textAlign+' <select id="keAlign" name="textAlign">','<option value="">'+i.alignDefault+"</option>",'<option value="left">'+i.alignLeft+"</option>",'<option value="center">'+i.alignCenter+"</option>",'<option value="right">'+i.alignRight+"</option>","</select> ",i.verticalAlign+' <select name="verticalAlign">','<option value="">'+i.alignDefault+"</option>",'<option value="top">'+i.alignTop+"</option>",'<option value="middle">'+i.alignMiddle+"</option>",'<option value="bottom">'+i.alignBottom+"</option>",'<option value="baseline">'+i.alignBaseline+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+i.border+"</label>",i.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',i.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+i.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join(""),r=n.createDialog({name:a,width:500,title:n.lang("tablecell"),body:o,beforeRemove:function(){w.unbind()},yesBtn:{name:n.lang("yes"),click:function(){var l=c.val(),t=s.val(),o=p.val(),a=g.val(),i=(v.val(),u.val(),h.val()),r=m.val(),d=b.val(),k=e(w[0]).html()||"",x=e(w[1]).html()||"";return/^\d*$/.test(l)?/^\d*$/.test(t)?/^\d*$/.test(d)?(f.css({width:""!==l?l+o:"",height:""!==t?t+a:"","background-color":x,"text-align":i,"vertical-align":r,"border-width":d,"border-style":""!==d?"solid":"","border-color":k}),n.hideDialog().focus(),void n.addBookmark()):(alert(n.lang("invalidBorder")),void b[0].focus()):(alert(n.lang("invalidHeight")),void s[0].focus()):(alert(n.lang("invalidWidth")),void c[0].focus())}}}),d=r.div,c=e('[name="width"]',d).val(100),s=e('[name="height"]',d),p=e('[name="widthType"]',d),g=e('[name="heightType"]',d),v=e('[name="padding"]',d).val(2),u=e('[name="spacing"]',d).val(0),h=e('[name="textAlign"]',d),m=e('[name="verticalAlign"]',d),b=e('[name="border"]',d).val(1),w=e(".ke-input-color",d);t(d,w.eq(0)),t(d,w.eq(1)),l(w.eq(0),"#000000"),l(w.eq(1),""),c[0].focus(),c[0].select();var k,f=n.plugin.getSelectedCell(),x=f[0].style.width||f[0].width||"",S=f[0].style.height||f[0].height||"";(k=/^(\d+)((?:px|%)*)$/.exec(x))?(c.val(k[1]),p.val(k[2])):c.val(""),(k=/^(\d+)((?:px|%)*)$/.exec(S))&&(s.val(k[1]),g.val(k[2])),h.val(f[0].style.textAlign||""),m.val(f[0].style.verticalAlign||"");var y=f[0].style.borderWidth||"";y&&(y=parseInt(y)),b.val(y),l(w.eq(0),e.toHex(f[0].style.borderColor||"")),l(w.eq(1),e.toHex(f[0].style.backgroundColor||"")),c[0].focus(),c[0].select()},insert:function(){this.prop(!0)},"delete":function(){var e=n.plugin.getSelectedTable();n.cmd.range.setStartBefore(e[0]).collapse(!0),n.cmd.select(),e.remove(),n.addBookmark()},colinsert:function(l){var t=n.plugin.getSelectedTable()[0],a=n.plugin.getSelectedRow()[0],i=n.plugin.getSelectedCell()[0],r=i.cellIndex+l;r+=t.rows[0].cells.length-a.cells.length;for(var d=0,c=t.rows.length;c>d;d++){var s=t.rows[d],p=s.insertCell(r);p.innerHTML=e.IE?"":"<br />",r=o(t,s,p)}n.cmd.range.selectNodeContents(i).collapse(!0),n.cmd.select(),n.addBookmark()},colinsertleft:function(){this.colinsert(0)},colinsertright:function(){this.colinsert(1)},rowinsert:function(l){var t=n.plugin.getSelectedTable()[0],o=n.plugin.getSelectedRow()[0],a=n.plugin.getSelectedCell()[0],i=o.rowIndex;1===l&&(i=o.rowIndex+(a.rowSpan-1)+l);for(var r=t.insertRow(i),d=0,c=o.cells.length;c>d;d++){o.cells[d].rowSpan>1&&(c-=o.cells[d].rowSpan-1);var s=r.insertCell(d);1===l&&o.cells[d].colSpan>1&&(s.colSpan=o.cells[d].colSpan),s.innerHTML=e.IE?"":"<br />"}for(var p=i;p>=0;p--){var g=t.rows[p].cells;if(g.length>d){for(var v=a.cellIndex;v>=0;v--)g[v].rowSpan>1&&(g[v].rowSpan+=1);break}}n.cmd.range.selectNodeContents(a).collapse(!0),n.cmd.select(),n.addBookmark()},rowinsertabove:function(){this.rowinsert(0)},rowinsertbelow:function(){this.rowinsert(1)},rowmerge:function(){var e=n.plugin.getSelectedTable()[0],l=n.plugin.getSelectedRow()[0],t=n.plugin.getSelectedCell()[0],a=l.rowIndex,i=a+t.rowSpan,r=e.rows[i];if(!(e.rows.length<=i)){var d=o(e,l,t);if(!(r.cells.length<=d)){var c=r.cells[d];t.colSpan===c.colSpan&&(t.rowSpan+=c.rowSpan,r.deleteCell(d),n.cmd.range.selectNodeContents(t).collapse(!0),n.cmd.select(),n.addBookmark())}}},colmerge:function(){var e=(n.plugin.getSelectedTable()[0],n.plugin.getSelectedRow()[0]),l=n.plugin.getSelectedCell()[0],t=(e.rowIndex,l.cellIndex),o=t+1;if(!(e.cells.length<=o)){var a=e.cells[o];l.rowSpan===a.rowSpan&&(l.colSpan+=a.colSpan,e.deleteCell(o),n.cmd.range.selectNodeContents(l).collapse(!0),n.cmd.select(),n.addBookmark())}},rowsplit:function(){var l=n.plugin.getSelectedTable()[0],t=n.plugin.getSelectedRow()[0],a=n.plugin.getSelectedCell()[0],i=t.rowIndex;if(1!==a.rowSpan){for(var r=o(l,t,a),d=1,c=a.rowSpan;c>d;d++){var s=l.rows[i+d],p=s.insertCell(r);a.colSpan>1&&(p.colSpan=a.colSpan),p.innerHTML=e.IE?"":"<br />",r=o(l,s,p)}e(a).removeAttr("rowSpan"),n.cmd.range.selectNodeContents(a).collapse(!0),n.cmd.select(),n.addBookmark()}},colsplit:function(){var l=(n.plugin.getSelectedTable()[0],n.plugin.getSelectedRow()[0]),t=n.plugin.getSelectedCell()[0],o=t.cellIndex;if(1!==t.colSpan){for(var a=1,i=t.colSpan;i>a;a++){var r=l.insertCell(o+a);t.rowSpan>1&&(r.rowSpan=t.rowSpan),r.innerHTML=e.IE?"":"<br />"}e(t).removeAttr("colSpan"),n.cmd.range.selectNodeContents(t).collapse(!0),n.cmd.select(),n.addBookmark()}},coldelete:function(){for(var l=n.plugin.getSelectedTable()[0],t=n.plugin.getSelectedRow()[0],o=n.plugin.getSelectedCell()[0],a=o.cellIndex,i=0,r=l.rows.length;r>i;i++){var d=l.rows[i],c=d.cells[a];c.colSpan>1?(c.colSpan-=1,1===c.colSpan&&e(c).removeAttr("colSpan")):d.deleteCell(a),c.rowSpan>1&&(i+=c.rowSpan-1)}0===t.cells.length?(n.cmd.range.setStartBefore(l).collapse(!0),n.cmd.select(),e(l).remove()):n.cmd.selection(!0),n.addBookmark()},rowdelete:function(){for(var l=n.plugin.getSelectedTable()[0],t=n.plugin.getSelectedRow()[0],o=n.plugin.getSelectedCell()[0],a=t.rowIndex,i=o.rowSpan-1;i>=0;i--)l.deleteRow(a+i);0===l.rows.length?(n.cmd.range.setStartBefore(l).collapse(!0),n.cmd.select(),e(l).remove()):n.cmd.selection(!0),n.addBookmark()}},n.clickToolbar(a,n.plugin.table.prop)});